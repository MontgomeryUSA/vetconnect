<!DOCTYPE html>
<html>
<head>
  <title>Chat With Login</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #chat-ui { display: none; }
    #chat-box { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; }
  </style>
</head>
<body>

<h2>VetConnect Chat</h2>

<div id="auth-ui">
  <input id="username" placeholder="Username"><br><br>
  <input id="password" placeholder="Password" type="password"><br><br>

  <button onclick="signup()">Sign Up</button>
  <button onclick="signin()">Sign In</button>
</div>

<div id="chat-ui">
  <button onclick="logout()">Sign Out</button>

  <h3>Chat</h3>
  <div id="chat-box"></div>

  <input id="msg" placeholder="Message...">
  <button onclick="sendMsg()">Send</button>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const API_URL = "https://chat.monty.my";
const socket = io(API_URL);

let user_id = localStorage.getItem("user_id");

if (user_id) {
  showChat();
} 

function signup() {
  fetch(`${API_URL}/signup`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      username: document.getElementById("username").value,
      password: document.getElementById("password").value
    })
  })
  .then(r => r.json())
  .then(res => {
    if (!res.success) return alert("Username already exists");
    localStorage.setItem("user_id", res.user_id);
    showChat();
  });
}

function signin() {
  fetch(`${API_URL}/signin`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      username: document.getElementById("username").value,
      password: document.getElementById("password").value
    })
  })
  .then(r => r.json())
  .then(res => {
    if (!res.success) return alert("Invalid credentials");
    localStorage.setItem("user_id", res.user_id);
    showChat();
  });
}

function logout() {
  localStorage.removeItem("user_id");
  location.reload();
}

function showChat() {
  document.getElementById("auth-ui").style.display = "none";
  document.getElementById("chat-ui").style.display = "block";

  loadMessages();
}

function loadMessages() {
  fetch(`${API_URL}/messages`)
    .then(r => r.json())
    .then(messages => {
      const box = document.getElementById("chat-box");
      box.innerHTML = "";
      messages.forEach(m => {
        const d = document.createElement("div");
        d.textContent = `${m.username}: ${m.content}`;
        box.appendChild(d);
      });
      box.scrollTop = box.scrollHeight;
    });
}

socket.on("new_message", m => {
  const box = document.getElementById("chat-box");
  const d = document.createElement("div");
  d.textContent = `User ${m.user_id}: ${m.content}`;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
});

function sendMsg() {
  socket.emit("send_message", {
    user_id: localStorage.getItem("user_id"),
    content: document.getElementById("msg").value
  });
  document.getElementById("msg").value = "";
}
</script>

</body>
</html>
